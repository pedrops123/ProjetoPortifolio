@model ProjetoPortifolio.ViewModel.PortifolioViewModel

@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .notify-badge {
        position: fixed;
        margin-left: -15px;
        background: red;
        text-align: center;
        border-radius: 30px 30px 30px 30px;
        color: white;
        padding: 1px 10px;
        margin-top: -18px;
        font-size: 20px;
    }

    #preview_fotos {
        margin-left: 21px;
    }

</style>


<h1> Modificação de Titulo Geral </h1>

<div class="alert alert-warning alert-dismissible fade show" id="msg-alerta" role="alert" style="display:none;">
    <div id="titulo_alerta"></div> <br /> <br />
    <div id="texto-alerta"> </div>
    <button type="button" id="close-alert" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<br />


<div class="modal fade" id="modalDinamico" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div id="typeHdn" hidden="hidden"></div>
                <div id="nomePagina" hidden="hidden"></div>
                <div id="hdnIdFoto" hidden="hidden"></div>
                <h5 class="modal-title" id="ModalTitulo"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="conteudo_fotos" class="modal-body">

            </div>
            <div class="modal-footer">

                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="data_fotos" onchange="adicionarFotoPreview()" name="imgs[]" multiple>
                    <label class="custom-file-label" for="customFile"></label>
                </div>

                <button type="button" style="display:none;" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="uploadFoto()">Gravar Fotos</button>
            </div>
            <div id="preview_fotos"></div>
        </div>
    </div>
</div>


@{
    int contador = 1;
    string IdFormulario = "formularioSubmit" + @contador.ToString();
    <fieldset class="col-md-auto">
        <form class="form-inline" id="@IdFormulario" action="">
            @foreach (string forms in Model.formularios)
            {
                @Html.Raw(forms + "&nbsp&nbsp&nbsp");
            }
        </form>

    </fieldset>
}

<br /><br />

<hr style="height:2px; border:thin; color:#000; background-color:#000; margin-top: 0px; margin-bottom: 0px;" />

<br />

<h1> Paginas Cadastradas </h1>

<button style="margin-left:920px; margin-top:-10px;" type="button" onclick="location.href='DadosTelaDinamicoManager'" class="btn btn-outline-success"> + Incluir nova pagina </button><br /><br />

<table class="table" align="center">
    <thead>
        <tr>
            <th scope="col"> ID </th>
            <th scope="col"> Pagina </th>
            <th scope="col"> Titulo da Aba </th>
            <th scope="col"> conteudo da pagina </th>
            <th scope="col"> Possui foto ? </th>
            <th scope="col"> Tem Formulario ? </th>
            <th scope="col"> Galeria Principal ? </th>
            <th scope="col"> Alterar dados </th>
        </tr>
    </thead>
    <tbody>
        @foreach (ItemsPaginaGeral dadosPagina in Model.listaPaginasSistema)
        {
            var temFoto = dadosPagina.hasFoto == true ? "Sim" : "Não";
            var temForm = dadosPagina.hasForm == true ? "Sim" : "Não";
            var isGaleria = dadosPagina.isMainPhoto == true ? "Sim" : "Não";
            <tr>
                <th scope="row"> @dadosPagina.id_pagina </th>
                <td> @dadosPagina.nome_pagina.Trim() </td>
                <td> @dadosPagina.titulo_aba.Trim() </td>
                <td> @Html.Raw(dadosPagina.conteudo_pagina.Trim()) </td>
                <td> @temFoto </td>
                <td> @temForm </td>
                <td> @isGaleria </td>
                <td>
                    <div class="form-check-inline">
                        @if (dadosPagina.hasFoto == true )
                        {
                            <a href="" data-placement="top" style="margin:20px;" class="tip-top" title="Incluir Fotos" data-toggle="modal" onclick="setDataModalFotos('@dadosPagina.nome_pagina')" data-target="#modalDinamico" shref=""><img width="30" height="30" src="~/icons/icon_photo.png" /></a>
                        }
                        @if (dadosPagina.hasForm == true)
                        {
                            <a href="" data-placement="top" style="margin:20px;" class="tip-top" data-toggle="tooltip" title="Incluir Formulário" shref=""><img width="30" height="30" src="~/icons/form_icon.png" /></a>
                        }
                        <button type="button" onclick="location.href='DadosTelaDinamicoManager?tagPagina=@dadosPagina.nome_pagina'" class="tip-top btn btn-info" data-placement="top" data-toggle="tooltip" title="Alterar dados da tela"> Alterar </button>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>


<script type="text/javascript">

    var fotosAdicionadas = [];
    /* Carrega dados titulo geral */ 
    window.onload = function () {
        $.ajax({
            type: "GET",
            url: "getDadosTituloGeral",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                document.getElementById("link_id").value = response[0];
                document.getElementById("desc_title_id").value = response[1];
            },
            failure: function () {
                alert("Ocorreu um erro na captura dos dados");
            }
        });
    }

    /* functions modal foto */
    function setDataModalFotos(nome) {
        limpaImagens();
        $("#typeHdn").text("foto");
        $("#nomePagina").text(nome);
        $("#ModalTitulo").html("Fotos Página " + nome);
        $(".custom-file-label").html("Escolha suas imagens...");
        $("#inputFileModal").show();

        $.ajax({
            type: 'GET',
            url: 'MakeImages',
            data: {
                idTela: nome
            },
            success: function (response) {
                if (response != "") {
                    $("#conteudo_fotos").html(response);
                } else {
                    $("#conteudo_fotos").html("Não há fotos incluidas! ");
                }
            },
            error: function (error) {
                alert("Ocorreu um erro na busca dos dados !");
            }
        });



    }

    function adicionarFotoPreview() {
        $("#preview_fotos").html("");
        fotosAdicionadas = Array.from(document.getElementById("data_fotos").files);
        $(".custom-file-label").html("");
        for (var i = 0; i < fotosAdicionadas.length; i++) {
            //Cria url da foto a ser subido
            var urlCriada = URL.createObjectURL(document.getElementById("data_fotos").files[i]);
            //Cria cada elemento div e da imagem preview
            $("#preview_fotos").append("<div data-placement='top' class='tip-top' data-toggle='tooltip' title='" + document.getElementById("data_fotos").files[i].name + "' id='" + document.getElementById("data_fotos").files[i].name + "'style='border:solid; margin:10px; display: -webkit-flex; -webkit-flex-wrap:wrap; display:inline-flex;flex-wrap:wrap;'><img width='80px' height='80px' src='" + urlCriada + "'><a style='cursor:pointer;'><span onclick='retiraFoto(\"" + document.getElementById("data_fotos").files[i].name + "\")' class='notify-badge'>x</span></a></img></div>");
            $(".custom-file-label").append(document.getElementById("data_fotos").files[i].name + ";" + " ");
        }
    }

    function limpaImagens() {
        $("#preview_fotos").html("");
        $("#data_fotos").val("");
    }

    function retiraFoto(tagFoto) {
        document.getElementById(tagFoto).remove();
        for (var i = 0; i < fotosAdicionadas.length; ++i) {
            if (fotosAdicionadas[i].name == tagFoto) {
                $(".custom-file-label").html($(".custom-file-label").html().replace(fotosAdicionadas[i].name + ";", ""));
                document.getElementById("data_fotos").files[i].removed = true;
            }
        }

        //document.getElementById("data_fotos").value = fotosAdicionadas;
    }

    function uploadFoto() {
        var data = Array.from(document.getElementById("data_fotos").files);
        var newData = data.filter(function (n) {
            return n.removed != true;
        });
        var nomePagina = $('#nomePagina').text();
        var tamanhoArray = newData.length;

        var formdata = new FormData();

        for (i = 0; i < tamanhoArray; i++) {
            formdata.append(newData[i].name + "*" + nomePagina + "*", newData[i]);
        }

        $.ajax({
            type: 'post',
            url: 'uploadImages',
            data: formdata,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (response) {
                if (response == true) {
                    alert('Imagens salvas com sucesso !!');
                    setDataModalFotos(nomePagina);
                } else {
                    alert('Nada foi salvo !');
                }

            },
            error: function (error) {
                alert("Atenção ocorreu um erro no upload de arquivos.");
            }
        });



    }

    function deleteImageBD(idimg) {
        var nomePagina = $('#nomePagina').text();

        $.ajax({
            type: 'POST',
            url: 'DeletaImagemBD',
            data: {
                idFoto: idimg
            },
            success: function (response) {
                if (response == true) {
                    alert('Foto deletada com sucesso !');
                    setDataModalFotos(nomePagina);
                } else {
                    alert('Erro no delete da imagem!');
                }
            },
            error: function (error) {
                alert("Ocorreu um erro no delete do dado !");
            }
        });

    }

    function chamaPopOver(idFoto) {

        $('[data-toggle="popover"]').popover('hide');

        $('.img-salva').popover({
            placement: 'top',
            html: true
        });
        //Desabilita o focus no modal para clicar no popover
        $(document).off('focusin.modal');
        $("#hdnIdFoto").text(idFoto);
        setTimeout(setDataPop, 10);
    }

    function setDataPop() {
        $(".popover-body").html("<form><div class='form-group'><label for='descImg'>Descrição  Imagem  &nbsp <br/></label><input id='cmpDesc' type=\"" + "text" + "\" class=\"" + "form-control" + "\" placeholder='Descrição da Imagem'> <br/> <button onclick='closePopOver()' type='button' class='btn btn-danger'> Fechar </button>  <button onclick='gravaDescricaoFoto()' type='button' class='btn btn-success'> Salvar Descrição </button></div></form>");     
        setTimeout(setTextPop, 400);
        
    }

    function setTextPop() {

        var idimg = parseInt($("#hdnIdFoto").text());
        $.ajax({
            type: 'GET',
            url: 'getDescImg',
            data: {
                idImg: idimg
            },
            success: function (response) {
                $('#cmpDesc').val(response);
            },
            error: function (error) {
                alert("Ocorreu um erro na busca dos dados !");
            }
        });  

    }

    function gravaDescricaoFoto() {
        var idimg = parseInt($("#hdnIdFoto").text());
        var desc = $("#cmpDesc").val();
        
        $.ajax({
            url: 'gravaDescricaoImagem',
            type: "POST",
            data: {
                idImagem: idimg,
                descricao: desc
            },
            success: function (retorno) {
                if (retorno == true) {
                    alert("Descrição salva com sucesso !");
                } else {
                    alert("Erro na gravacao da descricao !");
                }
               
            },
            error: function (error) {
                alert("Atenção ocorreu um erro no upload de arquivos.");
            }
        });
    }

    function closePopOver() {
        $('[data-toggle="popover"]').popover('hide');
    }
    
     /* final functions modal foto */

</script>







